<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:v="urn:schemas-microsoft-com:vml"
      xmlns:o="urn:schemas-microsoft-com:office:office">
<head>
    <title>Devprod Conciliador</title>
    <!--[if !mso]>-->
    <meta http-equiv="X-UA-Compatible"
          content="IE=edge">
    <!--<![endif]-->
    <meta http-equiv="Content-Type"
          content="text/html; charset=UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1">
    <meta name="color-scheme"
          content="light">
    <meta name="supported-color-schemes"
          content="light">


    <!--[if mso]>
    <xml>
        <o:OfficeDocumentSettings>
            <o:AllowPNG/>
            <o:PixelsPerInch>96</o:PixelsPerInch>
        </o:OfficeDocumentSettings>
    </xml>
    <![endif]-->
    <style>body {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .ExternalClass {
            width: 100%;
        }

        .ReadMsgBody {
            width: 100%;
        }

        .ExternalClass {
            line-height: 100%;
        }

        body {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
            margin: 0;
            min-width: 100%;
            padding: 0;
            width: 100% !important;
        }

        img {
            -ms-interpolation-mode: bicubic;
            max-width: 100%;
            width: auto;
        }

        img {
            border: none;
            outline: none;
            text-decoration: none;
        }

        body {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
            margin: 0;
            min-width: 100%;
            padding: 0;
            width: 100% !important;
        }

        body {
            color: #1a2e44;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
        }

        body {
            font-size: 14px;
            line-height: 1.5;
        }

        a:active {
            color: #008c70 !important;
        }

        a:hover {
            color: #008c70 !important;
        }

        a:visited {
            color: #008c70 !important;
        }

        .button-block .button a:visited {
            color: #fff !important;
            text-decoration: none;
        }

        .dns_table a:visited {
            color: #4c83ee !important;
            text-decoration: underline;
        }

        body {
            background-color: #f8fafa;
        }

        .footer a:active {
            color: #a3abb4 !important;
        }

        .footer a:hover {
            color: #a3abb4 !important;
        }

        .footer a:visited {
            color: #a3abb4 !important;
        }

        .footer .social-link:visited {
            color: #313a45 !important;
            opacity: .5;
        }

        .footer .social-link:active {
            color: #313a45 !important;
            opacity: 1 !important;
        }

        .footer .social-link:hover {
            color: #313a45 !important;
            opacity: 1 !important;
        }

        @media (max-width: 600px) {
            body {
                min-width: 100% !important;
                width: 100% !important;
            }

            a {
                -webkit-text-size-adjust: none !important;
                -moz-text-size-adjust: none !important;
                text-size-adjust: none !important;
            }

            body {
                -webkit-text-size-adjust: none !important;
                -moz-text-size-adjust: none !important;
                text-size-adjust: none !important;
            }

            p {
                -webkit-text-size-adjust: none !important;
                -moz-text-size-adjust: none !important;
                text-size-adjust: none !important;
            }

            table {
                -webkit-text-size-adjust: none !important;
                -moz-text-size-adjust: none !important;
                text-size-adjust: none !important;
            }

            td {
                -webkit-text-size-adjust: none !important;
                -moz-text-size-adjust: none !important;
                text-size-adjust: none !important;
            }

            img {
                height: auto !important;
                width: auto !important;
            }

            center {
                min-width: 0 !important;
            }

            table {
                width: 100% !important;
            }

            body {
                font-size: 16px;
                line-height: 1.4 !important;
            }

            table[class=body] {
                font-size: 16px;
                line-height: 1.4 !important;
            }

            .h1 {
                font-size: 22px !important;
                padding-bottom: 15px !important;
            }

            h1 {
                font-size: 22px !important;
                padding-bottom: 15px !important;
            }

            h2 {
                font-size: 20px !important;
            }

            p.lead {
                font-size: 21px !important;
                padding-bottom: 20px !important;
            }

            .button-block {
                width: auto !important;
            }

            .body {
                padding: 16px 0 !important;
            }

            .email-body {
                border-radius: 0 !important;
                margin-top: 16px !important;
            }

            .inner-footer.is-marketing {
                padding-bottom: 15px !important;
            }

            .inner-footer {
                padding: 20px 16px 30px !important;
            }

            .content {
                padding: 20px 15px !important;
            }

            .footer-container {
                padding: 24px 16px 0 !important;
            }

            .footer .footer-section {
                display: block !important;
                width: 100% !important;
            }

            .footer .social-block {
                text-align: center !important;
            }

            .footer .social-item {
                display: inline-block !important;
                text-align: center !important;
                width: 60px !important;
            }
        }

        @media (max-width: 480px) {
            .invoice-section .invoice-logo {
                display: none;
            }

            .column {
                display: block !important;
                padding: 0 0 15px !important;
                width: 100% !important;
            }
        }
    </style>
</head>

<body style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; min-width: 100%; width: 100% !important; color: #1a2e44; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif; font-size: 14px; line-height: 1.5; margin: 0; padding: 0;"
      bgcolor="#f8fafa">
{{--<div class="pre-header"
     style="color: #fff; display: none !important; font-size: 1px; line-height: 1px; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; visibility: hidden;">
    Your getting started guide
</div>--}}
<div class="body"
     style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; min-width: 100%; width: 100% !important; background-color: #f8fafa; margin: 0; padding: 32px 0;">
    <table style="width: 100%; -webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse; border-spacing: 0; table-layout: fixed; padding: 0; border-width: 0;"
           height="100%">
        <tr style="padding: 0;">
            <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; min-width: 100%; width: 100% !important; margin: 0; padding: 0;"
                class="email-container"
                align="center"
                valign="top">
                <img src="https://www.devprod.com.br/imagens/cinza.png"
                     class="devprod-logo"
                     alt="devprod logo"
                     draggable="false"
                     style="-ms-interpolation-mode: bicubic; max-width: 100%; /*width: 136px !important;*/ outline: none; text-decoration: none; height: 41px !important; border-style: none;">

                <table style="width: 780px; -webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: separate; border-spacing: 0; table-layout: auto; border-radius: 8px; margin-top: 24px; padding: 0; border: 1px solid #eee;"
                       class="email-body"
                       bgcolor="#fff">
                    <!-- Content -->
                    <tr style="padding: 0;">
                        <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; padding: 24px 32px 30px;"
                            class="content"
                            align="left"
                            valign="top">


                            <p style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; font-size: 14px; padding-bottom: 10px; margin: 0;">Ola!
                                <b>{{ $nome ?? 'Baratão da Carne' }}</b></p>

                            <p style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; font-size: 14px; padding-bottom: 10px; margin: 0;">Abaixo estão os dados consolidados do módulo <b>Fiscal</b>, com os totais apurados nos últimos 7 dias.</p>

                            <br>

                            @php
                                use Illuminate\Support\Carbon;

                                // Últimos 7 dias (formatados como Y-m-d)
                                $dias = collect(range(6, 0))->map(fn($i) => now()->subDays($i)->format('Y-m-d'));

                                // Agrupa os valores por query_id e data
                                $dados = $values->groupBy(function($item) {
                                    return $item->query_id;
                                })->map(function($itens) {
                                    return $itens->keyBy(function($item) {
                                        return \Illuminate\Support\Carbon::parse($item->created_at)->format('Y-m-d');
                                    });
                                });
                            @endphp

                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; text-align: left;">
                                <thead style="background-color: #f0f0f0; text-align: left;">
                                <tr>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Métrica</th>
                                    @foreach($dias as $dia)
                                        <th style="padding: 10px; border: 1px solid #ddd;">{{ \Carbon\Carbon::parse($dia)->format('d/m') }}</th>
                                    @endforeach
                                </tr>
                                </thead>
                                <tbody>
                                @foreach($dados as $queryId => $diasValores)
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">{{ $diasValores->first()?->titulo ?? 'Sem título' }}</td>
                                        @foreach($dias as $dia)
                                            <td style="padding: 10px; border: 1px solid #ddd;">
                                                @php
                                                    $totalHoje = $diasValores[$dia]->total ?? null;
                                                    $index = $loop->index;
                                                    $totalAnterior = $index > 0 ? ($diasValores[$dias[$index - 1]]->total ?? null) : null;
                                                @endphp

                                                @if(is_null($totalHoje))
                                                    -
                                                @else
                                                    {{ $totalHoje }}
                                                    @if(!is_null($totalAnterior))
                                                        @if($totalHoje > $totalAnterior)
                                                            <span style="color: red;">↑</span>
                                                        @elseif($totalHoje < $totalAnterior)
                                                            <span style="color: green;">↓</span>
                                                        @endif
                                                    @endif
                                                @endif
                                            </td>
                                        @endforeach
                                    </tr>
                                @endforeach
                                </tbody>
                            </table>

                            <br>

                            @php
                                $labels = $dias->map(fn($d) => \Carbon\Carbon::parse($d)->format('d/m'))->toArray();

                                // Gerar um dataset por query
                                $datasets = collect($dados)->map(function ($diasValores, $queryId) use ($dias) {
                                    return [
                                        'label' => $diasValores->first()?->titulo ?? "Query {$queryId}",
                                        'data' => $dias->map(fn($d) => $diasValores[$d]->total ?? 0),
                                        'fill' => false,
                                    ];
                                })->values()->toArray();

                                $chartConfig = [
                                    'type' => 'line',
                                    'data' => [
                                        'labels' => $labels,
                                        'datasets' => $datasets,
                                    ],
                                    'options' => [
                                        'title' => [
                                            'display' => true,
                                            'text' => 'Evolução Semanal por Métrica',
                                        ],
                                    ],
                                ];

                                $chartUrl = 'https://quickchart.io/chart?c=' . urlencode(json_encode($chartConfig));
                            @endphp

                            <img src="{{ $chartUrl }}" alt="Gráfico de evolução semanal"
                                 style="max-width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 4px;">

                            <br><br>

                            <p style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; font-size: 14px; padding-bottom: 10px; margin: 0;">Utilize essas informações para acompanhar a evolução das análises e identificar possíveis desvios ou inconsistências.</p>
                            {{--<ul style="padding-left: 15px; font-size: 14px; margin: 0;">
                                <li style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; padding-bottom: 10px;">
                                    <a target="_blank"
                                       rel="noopener noreferrer"
                                       href="https://sitefgw.martins.com.br/sitefweb"
                                       style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; color: #4c83ee !important;">SiTef-Gw Conciliação</a>
                                </li>
                            </ul>--}}
                            <br>
                            <p style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; font-size: 14px; padding-bottom: 10px; margin: 0;">Caso tenha mais perguntas ou queira entrar em contato, utilize as informações abaixo!</p>


                        </td>
                    </tr>

                    <!-- Content Footer -->
                    <tr style="padding: 0;">
                        <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; padding: 0 32px 24px;"
                            class="inner-footer"
                            align="left"
                            valign="middle">

                            <!-- Closing text -->
                            <table style="width: 50%; -webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse; border-spacing: 0; table-layout: auto; padding: 0; border-width: 0;">
                                <tr class="signature"
                                    style="padding: 0;">
                                    <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; border-top-width: 1px; border-top-color: #e4e4e9; border-top-style: solid; font-size: 12px; line-height: 1.5; padding: 15px 0 0;"
                                        class="close-text"
                                        align="left"
                                        valign="middle">
                                        <table style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse; border-spacing: 0; table-layout: auto; padding: 0; border-width: 0;">
                                            <tr style="padding: 0;">
                                                <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; padding: 0;">
                                                    <span>Atenciosamente,</span><br>
                                                    <br>
                                                    <strong>Equipe Devprod</strong><br>
                                                    <span class="signature-email"
                                                          style="color: #a3abb4; font-size: 10px;">suporte@devprod.com.br</span>
                                                </td>
                                            </tr>
                                        </table>

                                    </td>
                                </tr>
                            </table>

                        </td>
                    </tr>
                </table>

            </td>
        </tr>
        <tr style="padding: 0;">
            <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; padding: 24px 10px 0;"
                class="footer-container"
                align="center"
                valign="top">
                <table style="width: 580px; -webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse; border-spacing: 0; table-layout: auto; padding: 0; border-width: 0;">
                    <tr style="padding: 0;">
                        <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; color: #a3abb4; font-size: 11px; padding: 0;"
                            class="footer"
                            align="center"
                            valign="top">
                            <!-- Footer links -->
                            {{--<table style="width: 100%; -webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse; border-spacing: 0; table-layout: auto; color: #a3abb4; font-size: 11px; padding: 0; border-width: 0;"
                                   class="footer">
                                <tr style="padding: 0;">
                                    <td style="-webkit-text-size-adjust: 100%; -moz-text-size-adjust: 100%; text-size-adjust: 100%; mso-table-lspace: 0; mso-table-rspace: 0; border-collapse: collapse !important; -webkit-hyphens: auto; hyphens: auto; word-break: break-word; padding: 0;"
                                        class="footer-section"
                                        align="left"
                                        valign="middle">
                                        Railsware Products Studio LLC<br>
                                        925 N La Brea Ave, Suite 400, office 560, West Hollywood,<br>
                                        CA 90038, US
                                    </td>
                                </tr>
                            </table>--}}
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>
</body>
</html>